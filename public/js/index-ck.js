$(function(){"use strict";function p(e,t){setTimeout(function(){$(".screen:not([hidden])").attr("hidden","hidden").fadeOut(function(){$(e).removeAttr("hidden").fadeIn(t)})},1e3)}function d(){p("#zapper-main");t.connect(function(o){if(o)return alert("サーバとの接続に失敗しました。アプリケーションはご利用頂けません。");n=t.user;e=t.event(__lt_event__);$("#user-icon img").attr("src",n.photos[0]);$("#zapper-main h1:first").text(e.title);e.onZapSent=function(e){var t='url("/img/btnBg_00.png")';h.css("backgroundImage",t);$("#zap-button").text("(いいね!)").removeAttr("disabled");w("#zap-button",{relatedZapUUID:e.uuid,autoCloseSeconds:3})};e.subscribe("message",function(e){r.push(e);if(i){var t=common.renderMessage(e);a.find(":first").before(t)}else{s++;v()}});r=__lt_messages__.reverse();s=r.length;v()})}function v(){if(!s){o.text("").hide();u.removeClass("active")}else{o.text(s).show();u.addClass("active")}}function m(){var e=[];for(var t=r.length-1;t>=0;t--){var n=r[t];e.push(common.renderMessage(n))}a.html(e.join("")).show();s=0}function g(){a.empty().hide()}function b(e){var t=Date.now();(function n(){var r=Date.now(),i=r-t;if(i>e*1e3)E();else{var s=Math.floor(i/1e3);c.text(e-s);y=setTimeout(n,200)}})()}function w(e,t){f.addClass("active");t=t||{};f.data("options",t);l.val("");c.text("");f.show();t.relatedZapUUID||setTimeout(function(){l.focus()},0);if(t.autoCloseSeconds>0){var n=t.autoCloseSeconds;b(n)}}function E(){f.removeData("options").removeClass("active")}typeof window.setImmediate!="function"&&(window.setImmediate=async.setImmediate=async.nextTick=function(e){setTimeout(e,0)});var e,t=new Zapper,n,r,i,s=0,o=$("#msg-notifier .msg-count"),u=$("#msg-notifier .icon"),a=$("#messages"),f=$("#message-dialog"),l=f.find(".message-input"),c=f.find(".count"),h=$("#buttons-container");(function(){t.loggedIn?d():p("#login-screen")})();$("#login-command").fastClick(function(){t.login(null,function(e,t){if(e)return;d()})});(function(){var t=["btnBg_00.png","btnBg_01.png","btnBg_02.png","btnBg_03.png","btnBg_04.png","btnBg_05.png","zapBtn_off.png","zapBtn_on.png","msg_on.png","msg_off.png","msgBtn_off.png","msgBtn_on.png"],n="/img/";_.each(t,function(e){var t=new Image;t.src=n+e;t.onload=function(){console.log("preload image:"+e)}})})();$("#zap-button").fastClick(function(){if(!t.loggedIn)return alert("ログインしていません");var n=e.zap(),r=n.count;r===e.maxZapCount&&$(this).attr("disabled","disabled");var i='url("/img/btnBg_'+_.str.lpad(String(r),2,"0")+'.png")';h.css("backgroundImage",i)});$("#msg-notifier").fastClick(function(){i?g():m();v();i=!i});$("#message-dialog .send-message-button").fastClick(function(){if(!t.loggedIn)return alert("ログインしていません");var n=$("#message-dialog"),r=n.find(".message-input"),i=r.val();if(i.length===0)return;var s=n.data("options")||{};e.sendMessage(i,s.relatedZapUUID);r.val("");E()});$("#message-dialog .cancel-button").fastClick(function(){E()});var y;l.on("focus",function(){clearTimeout(y);c.text("")});$("#msg-button").fastClick(function(){w(this)});$("#logout-button").fastClick(function(){confirm("ログアウトしますか?")&&$.get("/logout",function(){location.reload()})})});