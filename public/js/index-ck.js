$(function(){"use strict";function d(e,t){setTimeout(function(){$(".screen:not([hidden])").attr("hidden","hidden").fadeOut(function(){$(e).removeAttr("hidden").fadeIn(t)})},1e3)}function v(){d("#zapper-main");t.connect(function(o){if(o)return alert("サーバとの接続に失敗しました。アプリケーションはご利用頂けません。");n=t.user;e=t.event(__lt_event__);$("#user-icon img").attr("src",n.photos[0]);$("#zapper-main h1:first").text(e.title);e.onZapSent=function(e){var t='url("/img/btnBg_00.png")';p.css("backgroundImage",t);$("#zap-button").text("(いいね!)").removeAttr("disabled");S("#zap-button",{relatedZapUUID:e.uuid,autoCloseSeconds:3})};e.subscribe("message",function(e){r.push(e);if(i){var t=common.renderMessage(e);f.find(":first").before(t)}else{s++;m()}});r=__lt_messages__.reverse();s=r.length;m()})}function m(){if(!s){u.text("").hide();a.removeClass("active")}else{u.text(s).show();a.addClass("active")}}function g(){if(!t.loggedIn)return alert("ログインしていません");var n=e.zap(),r=n.count;r===e.maxZapCount&&$(this).attr("disabled","disabled");var i='url("/img/btnBg_'+_.str.lpad(String(r),2,"0")+'.png")';p.css("backgroundImage",i)}function y(){var e=[];for(var t=r.length-1;t>=0;t--){var n=r[t];e.push(common.renderMessage(n))}f.html(e.join("")).show();s=0}function b(){f.empty().hide()}function E(e){var t=Date.now();(function n(){var r=Date.now(),i=r-t;if(i>e*1e3)x();else{var s=Math.floor(i/1e3);h.text(e-s);w=setTimeout(n,200)}})()}function S(e,t){l.addClass("active");t=t||{};l.data("options",t);c.val("");h.text("");l.show();t.relatedZapUUID||setTimeout(function(){c.focus()},0);if(t.autoCloseSeconds>0){var n=t.autoCloseSeconds;E(n)}}function x(){l.removeData("options").removeClass("active")}typeof window.setImmediate!="function"&&(window.setImmediate=async.setImmediate=async.nextTick=function(e){setTimeout(e,0)});var e,t=new Zapper,n,r,i,s=0,o=$("#zap-button"),u=$("#msg-notifier .msg-count"),a=$("#msg-notifier .icon"),f=$("#messages"),l=$("#message-dialog"),c=l.find(".message-input"),h=l.find(".count"),p=$("#buttons-container");(function(){t.loggedIn?v():d("#login-screen")})();(function(){window.scrollY===0&&setTimeout(function(){window.scrollTo(0,1)},100)})();$("#login-command").fastClick(function(){t.login(null,function(e,t){if(e)return;v()})});(function(){var t=["btnBg_00.png","btnBg_01.png","btnBg_02.png","btnBg_03.png","btnBg_04.png","btnBg_05.png","zapBtn_off.png","zapBtn_on.png","msg_on.png","msg_off.png","msgBtn_off.png","msgBtn_on.png"],n="/img/";_.each(t,function(e){var t=new Image;t.src=n+e;t.onload=function(){console.log("preload image:"+e)}})})();o.fastClick(g);$(window).on("shake",g);$("#msg-notifier").fastClick(function(){i?b():y();m();i=!i});$("#message-dialog .send-message-button").fastClick(function(){if(!t.loggedIn)return alert("ログインしていません");var n=$("#message-dialog"),r=n.find(".message-input"),i=r.val();if(i.length===0)return;var s=n.data("options")||{};e.sendMessage(i,s.relatedZapUUID);r.val("");x()});$("#message-dialog .cancel-button").fastClick(function(){x()});var w;c.on("focus",function(){clearTimeout(w);h.text("")});$("#msg-button").fastClick(function(){S(this)});$("#logout-button").fastClick(function(){confirm("ログアウトしますか?")&&$.get("/logout",function(){location.reload()})})});