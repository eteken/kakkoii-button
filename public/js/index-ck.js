$(function(){function f(e){n.init(function(r){if(r)return e(r);t=n.event(__lt_event__);$("#main-screen > h1").text(t.title);t.onZapSent=function(e){$("#zap-button").text("(いいね!)").removeAttr("disabled");E("#zap-button",{relatedZapUUID:e.uuid,autoCloseSeconds:3})};t.subscribe("zap",function(e){s.push(e)});t.subscribe("message",function(e){i.push(e);y([e])});i=__lt_messages__;delete window.__lt_messages__;setInterval(g,u);y(i);e()})}function l(){var e=$(window).width(),t=400;$("#zap-chart").attr({width:e,height:t}).css({width:e,height:t})}function g(){if(s.length===0)return;s.sort(function(e,t){return e.timestamp-t.timestamp});var e=new Date,t=(new Date(e.getFullYear(),e.getMonth(),e.getDate(),e.getHours(),e.getMinutes(),e.getSeconds()+1)).getTime(),n=(new Date(t-d)).getTime(),r,i,o=s.length-1,a=[];for(r=t;r>=n;r-=u){var f=0;for(i=o;i>=0;i--){var l=s[i],c=Date.parse(l.timestamp);if(!(r>=c&&r-c<=u)){o=i;break}f+=l.count}a.push(f)}a.reverse();console.log(a.join(","));s=s.slice(i);var h={labels:v,fillColor:"rgba(220,220,220,0.5)",strokeColor:"rgba(220,220,220,1)",pointColor:"rgba(220,220,220,1)",pointStrokeColor:"#fff",datasets:[{fillColor:"rgba(220,220,220,0.5)",strokeColor:"rgba(220,220,220,1)",data:a}]};p.Line(h,{pointDot:!1,bezierCurve:!0,scaleOverride:!0,scaleSteps:10,scaleStepWidth:1,scaleStartValue:0,animation:!1})}function y(t){var n=[];for(var r=0,i=t.length;r<i;r++)n.push(e(t[r]));var s=$(".zap-messages");s.html(n.join("")+s.html())}function b(){r=n.user;$(".user-thumbnail").attr("src",r.photos[0]);$("#command-area").fadeIn(1e3,function(){setTimeout(function(){$(".command-button").fadeIn(750,function(){})},600)})}function w(e,t,n){setTimeout(function(){$(e).fadeOut(function(){$(t).fadeIn(n)})},1e3)}function E(e,t){var n=$("#message-dialog");n.addClass("active");var r=n.outerWidth(),i=n.outerHeight(),s=($(window).width()-r)/2;n.css("left",s+"px");var o=$(e).offset();n.css("top",o.top-i);t=t||{};n.data("options",t);n.show();t.relatedZapUUID||setTimeout(function(){n.find(".message-input").focus()},0);var u=n.find(".count");if(t.autoCloseSeconds>0){var a=Date.now(),f=t.autoCloseSeconds;(function l(){var e=Date.now(),t=e-a;if(t>f*1e3)S();else{var n=Math.floor(t/1e3);u.text(f-n);setTimeout(l,200)}})()}else u.text("")}function S(){$("#message-dialog").removeData("options").hide()}_.templateSettings={evaluate:/\{\{(.+?)\}\}/g,interpolate:/\{\{=(.+?)\}\}/g,escape:/\{\{-(.+?)\}\}/g};var e=_.template($("#message-listitem-template").html());typeof window.setImmediate!="function"&&(window.setImmediate=async.setImmediate=async.nextTick=function(e){setTimeout(e,0)});var t,n=new Zapper,r,i,s=[],o=1,u=o*1e3,a=10;$(window).resize(l);l();var c=document.getElementById("zap-chart"),h=c.getContext("2d"),p=new Chart(h),d=a*u,v=[];for(var m=0;m<a;m++)v.push("");n.loggedIn?f(function(e){e&&alert("エラーが発生しました");w("#splash-screen","#main-screen",b)}):w("#splash-screen","#login-screen");$("#login-command").click(function(){n.login(null,function(e,t){if(e)return;f(function(e){e&&alert("エラーが発生しました");w("#login-screen","#main-screen",b)})})});$("#display-messages").change(function(){$(".zap-messages").toggle(this.checked)});$("#zap-button").click(function(){var e=t.zap();$(this).text("(いいね!)×"+e.count);e.count===n.maxZapCount&&$(this).attr("disabled","disabled")});$("#tweet-button").click(function(){E(this)});$("#message-dialog .send-message-button").click(function(){var e=$("#message-dialog"),n=e.find(".message-input"),r=n.val();if(r.length===0)return;var i=e.data("options")||{};t.sendMessage(r,i.relatedZapUUID);n.val("");S()});$("#message-dialog .cancel-button").click(function(){S()})});