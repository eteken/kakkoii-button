function collectInitialData(e,t){async.waterfall([function(t){models.Event.findById(e).exec(t)},function(e,n){if(!e)return t(new Error("Event not found"));async.parallel([function(t){models.Message.find({eventId:e._id}).select("text timestamp author zap seq").sort("-seq").limit(MESSAGES_PAGE_COUNT).exec(t)}],function(n,r){n?t(n):t(null,{event:e,messages:r[0]})})}])}function addUserMessage(e,t,n){var r=e.locals.messages;r||(e.local.messages=r={});var i=r[t];i||(r[t]=i=[]);i.push(n)}function postToTwitter(e,t,n){if(!appSettings.tweetWithMessage)return;models.Event.findById(n.eventId,function(e,r){if(e)return console.error(e);if(!r)return console.log("Cannot find event. ID:"+n.eventId);var i=[],s=0;if(r.hashtag){var o="#"+r.hashtag;i.push(o);s+=o.length;s+=1}if(r.shortLink){var u=r.shortLink;i.push(u);var a;u.indexOf("https")===0?a=23:a=22;s+=u.length<a?a:u.length;s+=1}i=i.join(" ");var f=140-s,l=n.text;l.length>f&&(l=l.substring(0,f-1)+"…");l+=" "+i;console.log("maxMessageLen:"+f);console.log(l);var c=new OAuth(null,null,TWITTER_CONSUMER_KEY,TWITTER_CONSUMER_SECRET,"1.0",null,"HMAC-SHA1",null,null);c.post("https://api.twitter.com/1.1/statuses/update.json",t.token,t.tokenSecret,{status:l},null,function(e,t,n){e&&console.log("status:"+e.statusCode);console.log("data:"+t)})})}function ensureAuthenticated(e,t,n){if(e.isAuthenticated())return n();t.redirect("/login")}var express=require("express"),partials=require("express-partials"),Session=express.session.Session,connect=require("connect"),http=require("http"),https=require("https"),OAuth=require("oauth").OAuth,passport=require("passport"),config=require("./config"),models=require("./models"),mongoose=require("mongoose"),util=require("util"),async=require("async"),_=require("underscore")._,TwitterStrategy=require("passport-twitter").Strategy,MongoStore=require("connect-mongo")(express),TWITTER_CONSUMER_KEY=config.twitter.consumerKey,TWITTER_CONSUMER_SECRET=config.twitter.consumerSecret,ZAP_INITIAL_LOAD_MINUTES=5,MESSAGES_PAGE_COUNT=100,appSettings={};setInterval(function(){models.Setting.find({},function(e,t){if(e)return console.error(e);t.length===0?appSettings={}:appSettings=t[0].value})},5e3);var shortenUrl=function(){var e="https://api-ssl.bitly.com/v3/shorten",t=encodeURIComponent(config.bitly.accessToken);return function(n,r){n=encodeURIComponent(n);var i=[e,"?access_token=",t,"&longUrl=",n].join("");https.get(i,function(e){if(e.statusCode!==200)return r(new Error("Error status code:"+e.statusCode));e.setEncoding("utf-8");e.on("data",function(e){var t=JSON.parse(e);if(t.status_code!==200)return r(new Error("Error status code:"+t.status_code));r(null,t.data.url)})}).on("error",function(e){r(e)})}}(),app=express(),cookieParser=express.cookieParser("kakkoii.tv"),sessionStore=new MongoStore({db:mongoose.connection.db}),SESSION_SECRET="kakkoii.tv";app.locals.fmtDate=function(e){return e?e.toISOString():""};app.configure(function(){app.set("port",process.env.PORT||3001);app.set("views",__dirname+"/views");app.set("view engine","ejs");app.use(express.favicon());app.use(express.static(__dirname+"/public"));app.use(express.logger("dev"));app.use(express.bodyParser());app.use(express.methodOverride());app.use(cookieParser);app.use(express.session({store:sessionStore,secret:SESSION_SECRET,cookie:{maxAge:6048e5}}));app.use(passport.initialize());app.use(passport.session());app.use(function(e,t,n){t.locals.user=e.session.user||null;t.locals.messages={};t.locals.appSettings=appSettings;n()});app.use(partials());app.use(app.router)});app.configure("development",function(){app.use(express.errorHandler())});var URL="http://localhost:"+app.get("port");(function(){var e=process.argv;if(e.length>2)for(var t=0;t<e.length;t++)if(e[t].match(/^\-\-url\=(.+)$/)){URL=RegExp.$1;break}})();console.log("URL: "+URL);passport.serializeUser(function(e,t){t(null,e._id)});passport.deserializeUser(function(e,t){models.User.findById(e,t)});passport.use(new TwitterStrategy({consumerKey:TWITTER_CONSUMER_KEY,consumerSecret:TWITTER_CONSUMER_SECRET,callbackURL:URL+"/auth/twitter/callback"},function(e,t,n,r){var i=Date.now();return models.User.findOne({number:n.id},function(s,o){if(s)return r(s);var u=o;if(!o){u=new models.User;u.created=i}u.number=n.id;u.name=n.username;u.displayName=n.displayName;u.photos=n.photos.map(function(e){return e.value});u.lastLogin=i;u.updated=i;u.oauthTokens={twitter:{token:e,tokenSecret:t}};u.save(r)})}));app.get("/",function(e,t){var n=e.param("eventId");if(!n){t.send(404);return}collectInitialData(n,function(n,r){t.render("index",{event:r.event.toObject({getters:!0}),messages:r.messages,user:e.user})})});app.get("/auth/twitter",passport.authenticate("twitter"),function(e,t){});app.get("/auth/twitter/callback",passport.authenticate("twitter",{failureRedirect:"/auth/failed"}),function(e,t){e.session.user=e.user;console.log("User object is persisted to session:"+JSON.stringify(e.session.user));var n=_.clone(e.session.user);delete n.oauthToken;var r=JSON.stringify(n);t.end("<script>opener.__lt_oauth_succeeded__=true;opener.__lt_logged_in_user__="+r+";"+"window.close();</script>")});app.get("/auth/failed",function(e,t){t.end("<script>opener.__lt_oauth_succeeded__=false;window.close();</script>")});app.get("/logout",function(e,t){e.session.destroy();e.logout();t.end('<!DOCTYPE html><meta charset="UTF-8"><title>ログアウトに成功しました</title><h1>ログアウトに成功しました。</h1>')});app.get("/*.html",function(e,t){t.render(e.params[0])});app.get("/events/latest",function(e,t){var n=new Date;models.Event.findOne({},{sort:"-start"},function(e,n){t.json(n)})});app.all("/admin/*",express.basicAuth("admin","kakkoii.tv.0"));app.get(/^\/admin\/$/,function(e,t){t.redirect("/admin/index.html")});app.get("/admin/settings",function(e,t){return t.render("admin/settings/index")});app.post("/admin/settings",function(e,t){var n=function(e,n){if(e)return t.send(500,e);appSettings=n.value;t.locals.appSettings=appSettings;addUserMessage(t,"info","設定を保存しました");return t.render("admin/settings/index")};models.Setting.findOne({},function(r,i){if(r)return t.send(500,r);if(!i)models.Setting.create({value:e.body},n);else{i.value=e.body;i.updated=new Date;i.save(n)}})});app.get("/admin/events",function(e,t){models.Event.find().sort("-start").exec(function(e,n){return e?t.send(500,e):t.render("admin/events/index",{events:n})})});app.get("/admin/events/create",function(e,t){return t.render("admin/events/editor",{event:{}})});app.get("/admin/events/edit",function(e,t){var n=e.param("id");models.Event.findById(n).exec(function(e,n){return e?t.send(500,e):n?t.render("admin/events/editor",{event:n}):t.send(404)})});app.post("/admin/events/:id",function(e,t){var n=e.param("id"),r=e.body,i=function(e,n){if(e)return t.send(500,e);addUserMessage(t,"info","イベントの作成に成功しました");t.render("admin/events/editor",{event:n})};async.waterfall([function(e){models.Event.findById(n,e)},function(e,t){var n=r.link&&r.link!==e.link;_.extend(e,r);n?async.waterfall([function(e){shortenUrl(r.link,e)},function(t,n){e.shortLink=t;e.save(n)}],function(e,n){e?t(e):n instanceof Array?t(null,n[0]):t(null,n)}):e.save(t)}],i)});app.put("/admin/events",function(e,t){var n=function(e,n){if(e)return t.send(500,e);addUserMessage(t,"info","イベントの作成に成功しました");t.render("admin/events/editor",{event:n})},r=e.body;r.link?async.waterfall([function(e){shortenUrl(r.link,e)},function(e,t){r.shortLink=e;models.Event.create(r,n)}],function(e,t){e?n(e):t instanceof Array?callback(null,t[0]):callback(null,t)}):models.Event.create(r,n)});app.delete("/admin/events/:id",function(e,t){var n=e.param("id");models.Event.findByIdAndRemove(n,function(e){if(e)return t.send(500,e);addUserMessage(t,"info","イベントの削除に成功しました");t.redirect("/admin/events")})});app.get("/events/:id/messages",function(e,t){models.Message.find({eventId:e.param("id")},null,{timestamp:0},function(e,n){if(e)throw e;t.json(n)})});app.get("/events/embed",function(e,t){var n=e.param("id");if(!n){t.send(404);return}collectInitialData(n,function(n,r){t.render("events/embed",{event:r.event.toObject({getters:!0}),messages:r.messages,user:e.user})})});var server=require("http").createServer(app),io=require("socket.io").listen(server);server.listen(app.get("port"),function(){console.log("Express server listening on port "+app.get("port"))});io.set("authorization",function(e,t){var n=e.headers.cookie;if(!n)return t(new Error("Cannot find cookie"),!1);n=require("cookie").parse(decodeURIComponent(n));n=connect.utils.parseSignedCookies(n,SESSION_SECRET);var r=n["connect.sid"];if(!r)return t(new Error("Cannot obtain sessionID"));sessionStore.get(r,function(i,s){if(i)t("Cannot get session: "+i.message,!1);else if(!s){console.log("session not found");t("session not found",!1)}else{console.log("Session found! "+JSON.stringify(s));e.cookie=n;e.sessionID=r;e.sessionStore=sessionStore;e.session=new Session(e,s);t(null,!0)}})});io.sockets.on("connection",function(e){console.log("connected");var t=e.handshake.session;if(!t){console.log("Session not found. Disconnect:"+e.id);e.disconnect(!0);return}console.log("Session found. Keep connection.");var n=t.user;if(!n){console.log("User not found in session. Session ID: "+t.id);e.disconnect(!0);return}var r=n.oauthTokens.twitter;e.on("zap",function(e){var t=Date.now(),r=new models.Zap(e);r.timestamp=t;r.author={_id:n._id,name:n.name,displayName:n.displayName,photo:n.photos[0]};r.save(function(e){if(e)throw e;io.sockets.json.emit("zap",r)})});e.on("message",function(e){var t=Date.now(),i=new models.Message(e);i.userId=n._id;i.timestamp=t;i.author={_id:n._id,name:n.name,displayName:n.displayName,photo:n.photos[0]};i.save(function(e){if(e)throw e;io.sockets.json.emit("message",i);postToTwitter(n,r,i)})});e.on("disconnect",function(){e.broadcast.emit("leave",e.id)})});